{% extends "nobleui_base.html" %}

{% block title %}Dashboard - Payymo{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
    <div>
        <h4 class="mb-3 mb-md-0">Welcome to Payymo Dashboard</h4>
    </div>
    <div class="d-flex align-items-center flex-wrap text-nowrap">
        <button type="button" class="btn btn-payymo-primary btn-icon-text mb-2 mb-md-0">
            <i data-feather="download" class="btn-icon-prepend"></i>
            Download Report
        </button>
    </div>
</div>

<!-- Stats Overview -->
<div class="row">
    <div class="col-12 col-xl-12 stretch-card">
        <div class="row flex-grow-1">
            <!-- Total Transactions -->
            <div class="col-md-6 col-lg-3 grid-margin stretch-card">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="card-title mb-0">Total Transactions</h6>
                            <div class="dropdown mb-2">
                                <a type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="icon-lg text-muted pb-3px" data-feather="more-horizontal"></i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="eye" class="icon-sm me-2"></i> <span class="">View</span></a>
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="download" class="icon-sm me-2"></i> <span class="">Export</span></a>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 col-md-12 col-xl-5">
                                <h3 class="mb-2">{{ stats.transactions.total|default(0) }}</h3>
                                <div class="d-flex align-items-baseline">
                                    <p class="text-success">
                                        <span>+{{ stats.transactions.month.count|default(0) }}</span>
                                        <i data-feather="arrow-up" class="icon-sm mb-1"></i>
                                    </p>
                                </div>
                            </div>
                            <div class="col-6 col-md-12 col-xl-7">
                                <div id="transactionsChart" class="mt-md-3 mt-xl-0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Total Amount -->
            <div class="col-md-6 col-lg-3 grid-margin stretch-card">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="card-title mb-0">Total Amount</h6>
                            <div class="dropdown mb-2">
                                <a type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="icon-lg text-muted pb-3px" data-feather="more-horizontal"></i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="eye" class="icon-sm me-2"></i> <span class="">View</span></a>
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="download" class="icon-sm me-2"></i> <span class="">Export</span></a>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 col-md-12 col-xl-5">
                                <h3 class="mb-2">£{{ stats.transactions.total_amount|default(0)|round(2) }}</h3>
                                <div class="d-flex align-items-baseline">
                                    <p class="text-success">
                                        <span>+£{{ stats.transactions.month.amount|default(0)|round(2) }}</span>
                                        <i data-feather="arrow-up" class="icon-sm mb-1"></i>
                                    </p>
                                </div>
                            </div>
                            <div class="col-6 col-md-12 col-xl-7">
                                <div id="amountChart" class="mt-md-3 mt-xl-0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bank Connections -->
            <div class="col-md-6 col-lg-3 grid-margin stretch-card">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="card-title mb-0">Bank Connections</h6>
                            <div class="dropdown mb-2">
                                <a type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="icon-lg text-muted pb-3px" data-feather="more-horizontal"></i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="eye" class="icon-sm me-2"></i> <span class="">View</span></a>
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="download" class="icon-sm me-2"></i> <span class="">Export</span></a>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 col-md-12 col-xl-5">
                                <h3 class="mb-2">{{ stats.bank_connections.total|default(0) }}</h3>
                                <div class="d-flex align-items-baseline">
                                    <p class="text-success">
                                        <span>{{ stats.bank_connections.active|default(0) }} active</span>
                                        <i data-feather="check" class="icon-sm mb-1"></i>
                                    </p>
                                </div>
                            </div>
                            <div class="col-6 col-md-12 col-xl-7">
                                <div id="bankConnectionsChart" class="mt-md-3 mt-xl-0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Matches -->
            <div class="col-md-6 col-lg-3 grid-margin stretch-card">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <h6 class="card-title mb-0">Invoice Matches</h6>
                            <div class="dropdown mb-2">
                                <a type="button" id="dropdownMenuButton3" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="icon-lg text-muted pb-3px" data-feather="more-horizontal"></i>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="eye" class="icon-sm me-2"></i> <span class="">View</span></a>
                                    <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="download" class="icon-sm me-2"></i> <span class="">Export</span></a>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 col-md-12 col-xl-5">
                                <h3 class="mb-2">{{ stats.matches.total|default(0) }}</h3>
                                <div class="d-flex align-items-baseline">
                                    <p class="text-success">
                                        <span>{{ stats.matches.confirmed|default(0) }} confirmed</span>
                                        <i data-feather="check" class="icon-sm mb-1"></i>
                                    </p>
                                </div>
                            </div>
                            <div class="col-6 col-md-12 col-xl-7">
                                <div id="matchesChart" class="mt-md-3 mt-xl-0"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Transactions Chart -->
    <div class="col-lg-8 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                    <h6 class="card-title mb-0">Transaction Overview</h6>
                    <div class="dropdown mb-2">
                        <a type="button" id="dropdownMenuButton4" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="icon-lg text-muted pb-3px" data-feather="more-horizontal"></i>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton4">
                            <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="eye" class="icon-sm me-2"></i> <span class="">View</span></a>
                            <a class="dropdown-item d-flex align-items-center" href="#"><i data-feather="download" class="icon-sm me-2"></i> <span class="">Export</span></a>
                        </div>
                    </div>
                </div>
                <p class="text-muted">Track your financial transactions over time</p>
                <div id="transactionOverviewChart" class="chart-container"></div>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="col-lg-4 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-baseline mb-2">
                    <h6 class="card-title mb-0">Recent Transactions</h6>
                    <div class="dropdown mb-2">
                        <a href="#" class="text-muted">View all</a>
                    </div>
                </div>
                <div class="d-flex flex-column">
                    {% if recent_transactions %}
                        {% for tx in recent_transactions[:5] %}
                        <div class="d-flex align-items-center border-bottom pb-3 mb-3 transaction-item">
                            <div class="transaction-icon bg-success-light rounded-circle me-3">
                                <i data-feather="arrow-down" class="text-success icon-md"></i>
                            </div>
                            <div class="flex-grow-1">
                                <p class="text-body mb-1">{{ tx.reference or 'Transaction #' + tx.id|string }}</p>
                                <small class="text-muted">{{ tx.transaction_date.strftime('%d %b %Y') }}</small>
                            </div>
                            <div class="text-end">
                                <h6 class="text-success mb-0">£{{ tx.amount|round(2) }}</h6>
                            </div>
                        </div>
                        {% endfor %}
                        {% if recent_transactions|length > 5 %}
                        <a href="#" class="btn btn-outline-primary btn-sm">View all transactions</a>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <i data-feather="credit-card" class="empty-state-icon mb-3"></i>
                            <p class="text-muted mb-3">No recent transactions found</p>
                            <button class="btn btn-outline-primary btn-sm">Add Transaction</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bank & Stripe Connections -->
<div class="row">
    <!-- Bank Connections -->
    <div class="col-md-6 grid-margin stretch-card">
        <div class="card connection-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-baseline mb-4">
                    <h6 class="card-title mb-0">Bank Connections</h6>
                    <button class="btn btn-payymo-primary btn-sm">
                        <i data-feather="plus" class="icon-sm"></i> Add Bank
                    </button>
                </div>
                {% if bank_connections %}
                    {% for bank in bank_connections %}
                    <div class="d-flex align-items-center border-bottom pb-3 mb-3 transaction-item">
                        <div class="connection-icon bg-primary-light rounded me-3 d-flex align-items-center justify-content-center">
                            <i data-feather="credit-card" class="text-primary icon-md"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-body mb-1">{{ bank.bank_name or 'Bank Account' }}</h6>
                            <p class="text-muted mb-0">Account: {{ bank.account_number[-4:] if bank.account_number else 'N/A' }}</p>
                        </div>
                        <div class="ms-3">
                            <span class="badge bg-{{ 'success' if bank.status == 'active' else 'warning' }}">{{ bank.status|title }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i data-feather="credit-card" class="empty-state-icon mb-3"></i>
                        <p class="text-muted mb-3">No bank connections found</p>
                        <button class="btn btn-payymo-primary btn-sm">Add Bank Connection</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Stripe Connections -->
    <div class="col-md-6 grid-margin stretch-card">
        <div class="card connection-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-baseline mb-4">
                    <h6 class="card-title mb-0">Stripe Connections</h6>
                    <button class="btn btn-payymo-primary btn-sm">
                        <i data-feather="plus" class="icon-sm"></i> Add Stripe
                    </button>
                </div>
                {% if stripe_connections %}
                    {% for stripe in stripe_connections %}
                    <div class="d-flex align-items-center border-bottom pb-3 mb-3 transaction-item">
                        <div class="connection-icon bg-info-light rounded me-3 d-flex align-items-center justify-content-center">
                            <i data-feather="zap" class="text-info icon-md"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="text-body mb-1">{{ stripe.account_name or 'Stripe Account' }}</h6>
                            <p class="text-muted mb-0">{{ stripe.email or 'No email' }}</p>
                        </div>
                        <div class="ms-3">
                            <span class="badge bg-{{ 'success' if stripe.status == 'active' else 'warning' }}">{{ stripe.status|title }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i data-feather="zap" class="empty-state-icon mb-3"></i>
                        <p class="text-muted mb-3">No Stripe connections found</p>
                        <button class="btn btn-payymo-primary btn-sm">Add Stripe Connection</button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    
    // Get theme
    const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'light';
    const isDarkMode = currentTheme === 'dark';
    
    // Chart colors based on theme
    const chartTextColor = isDarkMode ? '#8391a2' : '#6c757d';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Transaction Overview Chart
    var transactionOverviewOptions = {
        chart: {
            type: 'area',
            height: 300,
            parentHeightOffset: 0,
            toolbar: {
                show: false
            },
            foreColor: chartTextColor
        },
        series: [{
            name: 'Transactions',
            data: [30, 45, 32, 70, 40, 60, 80]
        }],
        xaxis: {
            categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
            axisBorder: {
                show: false
            },
            grid: {
                borderColor: gridColor,
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        colors: ['#0061f2'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.3,
                stops: [0, 90, 100]
            }
        },
        tooltip: {
            theme: isDarkMode ? 'dark' : 'light',
            y: {
                formatter: function(val) {
                    return val + " transactions";
                }
            }
        },
        grid: {
            borderColor: gridColor,
            padding: {
                left: 0,
                right: 0
            }
        }
    };

    if (document.getElementById('transactionOverviewChart')) {
        var transactionOverviewChart = new ApexCharts(document.getElementById('transactionOverviewChart'), transactionOverviewOptions);
        transactionOverviewChart.render();
    }
    
    // Small Sparkline Charts for Stats Cards
    const sparklineOptions = {
        chart: {
            type: 'line',
            height: 50,
            sparkline: {
                enabled: true
            },
            foreColor: chartTextColor
        },
        series: [{
            data: [25, 66, 41, 89, 63, 25, 44, 12, 36, 9, 54]
        }],
        stroke: {
            width: 2,
            curve: 'smooth'
        },
        tooltip: {
            fixed: {
                enabled: false
            },
            x: {
                show: false
            },
            y: {
                title: {
                    formatter: function(seriesName) {
                        return '';
                    }
                }
            },
            marker: {
                show: false
            },
            theme: isDarkMode ? 'dark' : 'light'
        }
    };
    
    // Transactions Chart
    if (document.getElementById('transactionsChart')) {
        const transactionsChart = new ApexCharts(document.getElementById('transactionsChart'), {
            ...sparklineOptions,
            colors: ['#0061f2']
        });
        transactionsChart.render();
    }
    
    // Amount Chart
    if (document.getElementById('amountChart')) {
        const amountChart = new ApexCharts(document.getElementById('amountChart'), {
            ...sparklineOptions,
            colors: ['#00ac69']
        });
        amountChart.render();
    }
    
    // Bank Connections Chart
    if (document.getElementById('bankConnectionsChart')) {
        const bankConnectionsChart = new ApexCharts(document.getElementById('bankConnectionsChart'), {
            ...sparklineOptions,
            colors: ['#00cfd5']
        });
        bankConnectionsChart.render();
    }
    
    // Matches Chart
    if (document.getElementById('matchesChart')) {
        const matchesChart = new ApexCharts(document.getElementById('matchesChart'), {
            ...sparklineOptions,
            colors: ['#f4a100']
        });
        matchesChart.render();
    }
    
    // Listen for theme changes
    window.addEventListener('themeChanged', function(e) {
        location.reload(); // Reload the page to reinitialize charts with correct theme colors
    });
});
</script>
{% endblock %} 