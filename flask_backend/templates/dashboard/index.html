{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Bank Connection Wizard Modal -->
{% include "components/bank_connection_wizard.html" %}

<!-- Stripe Connection Wizard Modal -->
{% include "components/stripe_connection_wizard.html" %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Welcome to Payymo</h4>
                <p class="card-text">Your Open Banking Integration for WHMCS</p>
                
                <div class="alert alert-info">
                    <i data-lucide="info" class="me-2"></i>
                    This is the dashboard page for the multi-tenant SaaS application. Here you can manage your tenant's financial data and integrations.
                </div>
                
                <div class="mt-3">
                    <h6>Quick Actions</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bankConnectionModal">
                            <i data-lucide="plus-circle" class="me-1" style="width: 16px; height: 16px;"></i>
                            Connect Bank
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#stripeConnectionModal">
                            <i data-lucide="link" class="me-1" style="width: 16px; height: 16px;"></i>
                            Connect Stripe
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-dark">
                            <i data-lucide="refresh-cw" class="me-1" style="width: 16px; height: 16px;"></i>
                            Sync Transactions
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Stats Cards -->
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card border-0 bg-primary bg-opacity-10">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Transactions</h5>
                        <h2 class="display-6 fw-bold">{{ stats.new_transactions_30_days }}</h2>
                        <p class="card-text text-muted">Last 30 days</p>
                    </div>
                    <div class="bg-primary bg-opacity-25 rounded-circle p-3">
                        <i data-lucide="credit-card" class="text-primary" style="width: 30px; height: 30px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card border-0 bg-success bg-opacity-10">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Invoices</h5>
                        <h2 class="display-6 fw-bold">{{ stats.new_invoices_30_days }}</h2>
                        <p class="card-text text-muted">Last 30 days</p>
                    </div>
                    <div class="bg-success bg-opacity-25 rounded-circle p-3">
                        <i data-lucide="file-text" class="text-success" style="width: 30px; height: 30px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card border-0 bg-warning bg-opacity-10">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Pending Matches</h5>
                        <h2 class="display-6 fw-bold">{{ stats.pending_matches }}</h2>
                        <p class="card-text text-muted">Need attention</p>
                    </div>
                    <div class="bg-warning bg-opacity-25 rounded-circle p-3">
                        <i data-lucide="alert-triangle" class="text-warning" style="width: 30px; height: 30px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
        <div class="card border-0 bg-info bg-opacity-10">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">Balance</h5>
                        <h2 class="display-6 fw-bold">Â£{{ stats.total_transaction_amount|round(2) }}</h2>
                        <p class="card-text text-muted">Current balance</p>
                    </div>
                    <div class="bg-info bg-opacity-25 rounded-circle p-3">
                        <i data-lucide="wallet" class="text-info" style="width: 30px; height: 30px;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Transactions -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Transactions</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>{{ transaction.transaction_date|default('-') }}</td>
                                <td>{{ transaction.description|default('No description')|truncate(30) }}</td>
                                <td class="{% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ transaction.currency|default('GBP') }} {{ transaction.amount|round(2) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-lucide="credit-card" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                    <p class="text-muted">No transactions found</p>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bankConnectionModal">Connect Bank Account</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Invoices -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Invoices</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_invoices %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in recent_invoices %}
                            <tr>
                                <td>{{ invoice.source_id|default('-') }}</td>
                                <td>{{ invoice.invoice_date|default('-') }}</td>
                                <td>{{ invoice.client_name|default('Unknown')|truncate(20) }}</td>
                                <td>{{ invoice.currency|default('GBP') }} {{ invoice.amount|round(2) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-lucide="file-text" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                    <p class="text-muted">No invoices found</p>
                    <a href="#" class="btn btn-sm btn-primary">Configure WHMCS Integration</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Integrations -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-transparent">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Integrations</h5>
                    <a href="#" class="btn btn-sm btn-outline-primary">Manage Integrations</a>
                </div>
            </div>
            <div class="card-body">
                {% if integrations %}
                <div class="row">
                    {% for integration in integrations %}
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card h-100 border">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-title mb-0">{{ integration.name }}</h6>
                                    <span class="badge {% if integration.status == 'active' %}bg-success{% elif integration.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ integration.status|capitalize }}
                                    </span>
                                </div>
                                <p class="card-text small">{{ integration.type|capitalize }} Integration</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <small class="text-muted">Last sync: {{ integration.last_sync_at|default('Never') }}</small>
                                    <a href="#" class="btn btn-sm btn-outline-secondary">Configure</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i data-lucide="link" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                    <p class="text-muted">No integrations configured</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bankConnectionModal">Connect Bank</button>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#stripeConnectionModal">Connect Stripe</button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Apply animations to dashboard elements
        const animateElements = () => {
            // Animate stats cards
            document.querySelectorAll('.card').forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('animate__animated', 'animate__fadeIn');
                }, 100 * index);
            });
            
            // Apply number counting animation to stats
            document.querySelectorAll('.display-6').forEach((element) => {
                const target = parseFloat(element.innerText.replace(/[^0-9.-]+/g, '') || 0);
                const duration = 1500;
                const increment = target / (duration / 16);
                let current = 0;
                
                // Skip animation for zero values
                if (target === 0) return;
                
                // Store original text with currency symbol if present
                const originalText = element.innerText;
                const hasCurrency = originalText.match(/[Â£$â¬]/);
                const currencySymbol = hasCurrency ? hasCurrency[0] : '';
                
                const counter = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        element.innerText = originalText;
                        clearInterval(counter);
                    } else {
                        // Add back currency symbol if it existed
                        element.innerText = currencySymbol + Math.floor(current).toLocaleString();
                    }
                }, 16);
            });
        };
        
        // Run animations after a short delay
        setTimeout(animateElements, 300);
        
        // Setup responsive card grid
        const setupResponsiveGrid = () => {
            const cards = document.querySelectorAll('.col-lg-4.col-md-6.mb-3');
            const container = document.querySelector('.row:has(.col-lg-4.col-md-6.mb-3)');
            
            if (!container || cards.length === 0) return;
            
            // Adjust column size based on number of cards
            if (cards.length === 1) {
                cards[0].className = 'col-md-6 mb-3 mx-auto';
            } else if (cards.length === 2) {
                cards.forEach(card => {
                    card.className = 'col-md-6 mb-3';
                });
            }
        };
        
        setupResponsiveGrid();
    });
</script>
{% endblock %}